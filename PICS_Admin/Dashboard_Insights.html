<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Insights - picsattestation.in</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --muted: #6b7280;
      --card-shadow: 0 10px 30px rgba(12,15,35,0.04);
      --card-border: rgba(15,23,42,0.03);
    }
    body { background:#f5f7fb; color:#0f172a; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; }
    .page-wrap { max-width:1100px; margin:26px auto; padding:0 18px; }
    .topbar { display:flex; align-items:center; gap:14px; margin-bottom:18px; }
    .back-circle { background:#3a3a3a; color:#fff; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; box-shadow:0 4px 12px rgba(17,24,39,0.08); }
    .back-circle:hover { transform:translateY(-2px); background:#2b2b2b; }

    .form-container { background:#fff; padding:20px; border-radius:12px; box-shadow:var(--card-shadow); border:1px solid var(--card-border); }
    .cards { display:flex; gap:14px; margin-bottom:14px; flex-wrap:wrap; }
    .stat-card { flex:1 1 220px; min-width:220px; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:10px; padding:12px; border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(12,15,35,0.03); }
    .stat-card h6 { margin:0; font-size:13px; color:var(--muted); }
    .stat { font-size:26px; font-weight:700; margin-top:8px; color:#0f172a; }

    .chart-box { background:#fff; border-radius:10px; padding:16px; box-shadow:var(--card-shadow); border:1px solid var(--card-border); }
    .muted { color:var(--muted); font-size:13px; }
    /* Add inside your existing <style> */
.chart-box { position: relative; }
.chart-box canvas {
  width: 100% !important;
  height: 260px !important;   /* fixed height — change to desired px */
  display: block;
}
.logout-btn {
    position: absolute;
    top: 15px;        /* place near top */
    right: 20px;      /* place at right */
    background: #ff4d4f;
    border: none;
    color: white;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    z-index: 9999;    /* ensure stays above content */
}
body {
    padding-top: 20px; /* pushes content down so logout button won't overlap */
}


    .debug { margin-top:12px; font-family:monospace; font-size:12px; color:#111; background:#fff; padding:10px; border-radius:8px; border:1px solid #eee; overflow:auto; max-height:160px;}
    @media (max-width:780px) { .cards { flex-direction:column; } }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="topbar">
      <button class="back-circle" onclick="goBack()" aria-label="Back"><i class="fa fa-arrow-left"></i></button>
      <button class="logout-btn" id="logoutBtn">Logout</button>

      <div>
        <h3 style="margin:0">Insights</h3>
        <div class="muted">Website visitors — picsattestation.in</div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <label class="muted mb-0">Range</label>
        <select id="rangeSelect" class="form-select form-select-sm" style="width:130px;">
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>
    </div>

    <div class="form-container">
      <div class="cards">
        <div class="stat-card">
          <h6>Total visitors (range)</h6>
          <div id="totalVisitors" class="stat">—</div>
          <div class="muted" style="margin-top:8px">Total visits in the selected range</div>
        </div>

        <div class="stat-card">
          <h6>Visitors (today)</h6>
          <div id="todayVisitors" class="stat">—</div>
          <div class="muted" style="margin-top:8px">Visits for today</div>
        </div>

        <div class="stat-card">
          <h6>Last updated</h6>
          <div id="lastUpdated" class="stat">—</div>
          <div class="muted" style="margin-top:8px">Time when this page last fetched data</div>
        </div>
      </div>

      <div class="chart-box">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <strong>Daily visits</strong>
            <div class="muted">Breakdown per day</div>
          </div>
          <div class="muted" id="summarySmall">—</div>
        </div>
        <canvas id="visitsChart" height="120"></canvas>

        <!-- debug area: shows raw worker warnings / response for troubleshooting -->
        <div id="workerDebug" class="debug" aria-live="polite"style='display:none;'>
          <strong>Worker debug:</strong>
          <pre id="workerDebugText">waiting...</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase auth (keeps your session check) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseConfig.js"></script>
      <script src="Logout.js"></script>


  <script>
    // keep your existing Supabase session check
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (!session) {
        window.location.href = "Login_Admin.html";
      }
   
    const role = session.user.user_metadata?.role;
    if (role === "staff") {
        window.location.href = "Login_Admin.html";
    } 
    });
          document.getElementById("logoutBtn").addEventListener("click", logoutUser);

    function goBack(){ window.location.href = "Dashboard_Admin.html"; }
  </script>

  <script>
  /******************************
   * CONFIG
   ******************************/
  const WORKER_PUBLIC_URL = "https://flat-resonance-1865.skpradhas.workers.dev"; // your worker
  const MIN_FETCH_INTERVAL_MS = 800; // prevent accidental repeated calls

  /******************************
   * Chart setup
   ******************************/
  let visitsChart;
  function renderChart(labels = [], values = []) {
  const ctx = document.getElementById("visitsChart").getContext("2d");
  if (visitsChart) visitsChart.destroy();
  visitsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Visits',
        data: values,
        fill: true,
        tension: 0.28,
        pointRadius: 3,
        borderWidth: 2
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { autoSkip: true } },
        y: { beginAtZero: true, ticks: { precision:0 } }
      },
      // IMPORTANT: keep maintainAspectRatio true, chart will use the canvas size above
      maintainAspectRatio: true,
      // aspectRatio is width/height ratio — since we set a fixed CSS height, a modest ratio is fine
      aspectRatio: 4, 
      responsive: true
    }
  });
}


  /******************************
   * Fetch + UI logic
   ******************************/
  let isFetching = false;
  let lastFetchTime = 0;

 

  function setLoadingUI() {
    document.getElementById("totalVisitors").textContent = "Loading...";
    document.getElementById("todayVisitors").textContent = "Loading...";
    document.getElementById("summarySmall").textContent = "Loading...";
  }

  function setErrorUI(msg) {
    document.getElementById("totalVisitors").textContent = "—";
    document.getElementById("todayVisitors").textContent = "—";
    document.getElementById("summarySmall").textContent = msg || "Failed to load";
    document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
  }

  // compute today index in returned date array using IST timezone (UTC+5:30)
  function getTodayIndexFromDates(dates) {
    if (!Array.isArray(dates) || dates.length === 0) return -1;
    const now = new Date();
    const istTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000));
    const istISODate = istTime.toISOString().substring(0, 10);
    return dates.indexOf(istISODate);
  }

  async function fetchVisits(days = 7) {
    // guard: avoid repeating too often
    const now = Date.now();
    if (isFetching) return null;
    if (now - lastFetchTime < MIN_FETCH_INTERVAL_MS) return null;

    isFetching = true;
    setLoadingUI();

    // cache-buster param to force fresh Worker results
    const url = `${WORKER_PUBLIC_URL}?days=${encodeURIComponent(days)}&_ts=${Date.now()}`;

    try {
      const resp = await fetch(url, { cache: "no-cache" });
      const txt = await resp.text();
      lastFetchTime = Date.now();

      // try parse JSON, else return error
      let json;
      try { json = JSON.parse(txt); } catch (e) {
        debugOut({ error: "invalid_json", body: txt });
        setErrorUI("Invalid response");
        return null;
      }

      // show warnings if present
      if (json?.warnings && Array.isArray(json.warnings) && json.warnings.length > 0) {
        debugOut(json.warnings);
      } else {
        debugOut(json);
      }

      // result validation
      if (!json || !Array.isArray(json.dates) || !Array.isArray(json.visits)) {
        setErrorUI("No data");
        return null;
      }

      return json;
    } catch (err) {
      debugOut({ error: String(err) });
      setErrorUI("Fetch failed");
      return null;
    } finally {
      isFetching = false;
      // small delay before allowing another fetch
      setTimeout(()=> { lastFetchTime = Date.now(); }, 300);
    }
  }

   function debugOut(obj) {
    const el = document.getElementById("workerDebugText");
    try {
      el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    } catch (e) {
      el.textContent = String(obj);
    }
  }
  function updateUIWithData(data) {
    if (!data || !Array.isArray(data.dates) || data.dates.length === 0) {
      setErrorUI("No data");
      renderChart([], []);
      return;
    }

    // compute total/today with fallbacks
    let total = Number(data.total || 0);
    if ((!total || total === 0) && Array.isArray(data.visits)) {
      total = data.visits.reduce((a,b) => a + Number(b || 0), 0);
    }

    let today = Number(data.today || 0);
    if ((!today || today === 0)) {
      const idx = getTodayIndexFromDates(data.dates);
      if (idx >= 0 && data.visits && data.visits.length > idx) {
        today = Number(data.visits[idx] || 0);
      } else {
        // fallback: last non-zero day
        const rev = [...(data.visits || [])].reverse();
        today = rev.find(v => Number(v) > 0) ?? 0;
      }
    }

    document.getElementById("totalVisitors").textContent = total.toLocaleString();
    document.getElementById("todayVisitors").textContent = (today || 0).toLocaleString();
    document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
    document.getElementById("summarySmall").textContent = `${total.toLocaleString()} visits • ${(today||0).toLocaleString()} today`;

    renderChart(data.dates || [], data.visits || []);
  }

  /******************************
   * Range wiring (robust + debounced)
   ******************************/
  function parseDaysFromSelect(sel) {
    if (!sel) return 7;
    const v = (sel.value || "").toString().trim();
    if (/^\d+$/.test(v)) return Number(v);
    const text = (sel.options[sel.selectedIndex]?.text || "");
    const m = text.match(/(\d{1,3})/);
    if (m) return Number(m[1]);
    return 7;
  }

  function initRange() {
    const sel = document.getElementById("rangeSelect");
    if (!sel) return;

    // normalize option values to numbers
    for (const opt of Array.from(sel.options)) {
      if (!/^\d+$/.test(opt.value)) {
        const m = (opt.text || "").match(/(\d{1,3})/);
        opt.value = m ? m[1] : "7";
      }
    }

    let debounceTimer = null;
    sel.addEventListener("change", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        const days = parseDaysFromSelect(sel);
        const data = await fetchVisits(days);
        if (data) updateUIWithData(data);
      }, 180);
    });

    // initial load
    setTimeout(async () => {
      const days = parseDaysFromSelect(sel);
      const data = await fetchVisits(days);
      if (data) updateUIWithData(data);
    }, 80);
  }

  // When DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initRange);
  } else {
    initRange();
  }



  </script>
</body>
</html>
