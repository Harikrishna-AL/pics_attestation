<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Insights - picsattestation.in</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --muted: #6b7280;
      --card-shadow: 0 10px 30px rgba(12,15,35,0.04);
      --card-border: rgba(15,23,42,0.03);
    }
    body { background:#f5f7fb; color:#0f172a; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; }
    .page-wrap { max-width:1100px; margin:26px auto; padding:0 18px; }
    .topbar { display:flex; align-items:center; gap:14px; margin-bottom:18px; }
    .back-circle { background:#3a3a3a; color:#fff; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; box-shadow:0 4px 12px rgba(17,24,39,0.08); }
    .back-circle:hover { transform:translateY(-2px); background:#2b2b2b; }

    .form-container { background:#fff; padding:20px; border-radius:12px; box-shadow:var(--card-shadow); border:1px solid var(--card-border); }
    .cards { display:flex; gap:14px; margin-bottom:14px; flex-wrap:wrap; }
    .stat-card { flex:1 1 220px; min-width:220px; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:10px; padding:12px; border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(12,15,35,0.03); }
    .stat-card h6 { margin:0; font-size:13px; color:var(--muted); }
    .stat { font-size:26px; font-weight:700; margin-top:8px; color:#0f172a; }

    .chart-box { background:#fff; border-radius:10px; padding:16px; box-shadow:var(--card-shadow); border:1px solid var(--card-border); }
    .muted { color:var(--muted); font-size:13px; }
    @media (max-width:780px) { .cards { flex-direction:column; } }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="topbar">
      <button class="back-circle" onclick="goBack()" aria-label="Back"><i class="fa fa-arrow-left"></i></button>
      <div>
        <h3 style="margin:0">Insights</h3>
        <div class="muted">Website visitors — picsattestation.in</div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <label class="muted mb-0">Range</label>
        <select id="rangeSelect" class="form-select form-select-sm" style="width:110px;">
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>
    </div>

    <div class="form-container">
      <div class="cards">
        <div class="stat-card">
          <h6>Total visitors (range)</h6>
          <div id="totalVisitors" class="stat">—</div>
          <div class="muted" style="margin-top:8px">Total visits in the selected range</div>
        </div>

        <div class="stat-card">
          <h6>Visitors (today)</h6>
          <div id="todayVisitors" class="stat">—</div>
          <div class="muted" style="margin-top:8px">Visits for today</div>
        </div>

        <div class="stat-card">
          <h6>Last updated</h6>
          <div id="lastUpdated" class="stat">—</div>
          <div class="muted" style="margin-top:8px">Time when this page last fetched data</div>
        </div>
      </div>

      <div class="chart-box">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <strong>Daily visits</strong>
            <div class="muted">Breakdown per day</div>
          </div>
          <div class="muted" id="summarySmall">—</div>
        </div>
        <canvas id="visitsChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- Supabase auth (keeps your session check) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseConfig.js"></script>

  <!-- (Optional) Cloudflare client-side beacon — replace token if you want client-side RUM -->
  <!-- <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "YOUR_BEACON_TOKEN"}'></script> -->

  <script>
    // keep your existing Supabase session check
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (!session) {
        window.location.href = "Login_Admin.html";
      }
    });

    function goBack(){ window.location.href = "Dashboard_Admin.html"; }
  </script>

  
 <script>
  // CONFIG: your worker url
  const WORKER_PUBLIC_URL = "https://flat-resonance-1865.skpradhas.workers.dev";

  // Simple guard to avoid multiple concurrent fetches
  let isFetching = false;
  let lastFetchAt = 0; // timestamp of last successful fetch (ms)
  const FETCH_MIN_INTERVAL_MS = 3000; // minimum gap between fetches

  // Remove any accidental scroll handlers that might be triggering refreshes
  // (some other scripts or service worker might have added them)
  try { window.onscroll = null; window.removeEventListener('scroll', window._insightsAutoScrollFetcher); } catch (e) {}

  async function fetchVisits(days = 7) {
    // Prevent too-frequent calls
    const now = Date.now();
    if (isFetching) return null;
    if (now - lastFetchAt < FETCH_MIN_INTERVAL_MS) return null;

    isFetching = true;
    try {
      const resp = await fetch(`${WORKER_PUBLIC_URL}?days=${days}`, { cache: "no-cache" });
      if (!resp.ok) {
        const txt = await resp.text();
        console.error("Worker responded with error:", resp.status, txt);
        return null;
      }
      const json = await resp.json();
      lastFetchAt = Date.now();
      return json;
    } catch (err) {
      console.error("Fetch failed:", err);
      return null;
    } finally {
      // small delay to avoid immediate refires
      setTimeout(() => { isFetching = false; }, 300);
    }
  }

  // compute today index in returned date array using IST timezone (UTC+5:30)
  function getTodayIndexFromDates(dates) {
    if (!Array.isArray(dates) || dates.length === 0) return -1;
    const now = new Date();
    // convert current time to IST
    const istTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000));
    const istISODate = istTime.toISOString().substring(0, 10);
    return dates.indexOf(istISODate);
  }

  // update UI cards and chart (chart code must exist in page)
  function updateUIWithData(data) {
    if (!data || !Array.isArray(data.dates) || data.dates.length === 0) {
      document.getElementById("totalVisitors").textContent = "No data";
      document.getElementById("todayVisitors").textContent = "No data";
      document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
      if (typeof renderChart === "function") renderChart([], []);
      return;
    }

    // If the worker already provides total/today, prefer that.
    let total = Number(data.total || 0);
    let today = Number(data.today || 0);

    // If today is 0 but dates exist, compute today using IST index (fallback)
    if ((!today || today === 0) && Array.isArray(data.dates) && data.dates.length > 0) {
      const idx = getTodayIndexFromDates(data.dates);
      if (idx >= 0 && Array.isArray(data.visits) && data.visits.length > idx) {
        today = Number(data.visits[idx] || 0);
      } else {
        // fallback: last non-empty day
        const rev = [...(data.visits || [])].reverse();
        today = rev.find(v => Number(v) > 0) ?? 0;
      }
    }

    // If total is 0 but visits array exists, compute sum as fallback
    if ((!total || total === 0) && Array.isArray(data.visits)) {
      total = data.visits.reduce((a,b)=>a + Number(b || 0), 0);
    }

    document.getElementById("totalVisitors").textContent = total > 0 ? total.toLocaleString() : "0";
    document.getElementById("todayVisitors").textContent = today > 0 ? today.toLocaleString() : "0";
    document.getElementById("lastUpdated").textContent = new Date().toLocaleString();

    // draw chart if renderChart exists (your Chart.js code)
    if (typeof renderChart === "function") {
      renderChart(data.dates || [], data.visits || []);
    }
  }

  // main refresh wrapper (debounced and guarded)
  async function refreshVisits(days = 7) {
    // quick guard: don't start if fetching
    if (isFetching) return;
    const data = await fetchVisits(days);
    if (data) {
      updateUIWithData(data);
    } else {
      // show fallback or leave last known state
      // if there's absolutely no data, UI updated by updateUIWithData(null) elsewhere
      console.warn("No data returned from worker.");
    }
  }

  // wire range select
  const rangeSelect = document.getElementById("rangeSelect");
  if (rangeSelect) {
    rangeSelect.addEventListener("change", (e) => {
      const days = Number(e.target.value) || 7;
      refreshVisits(days);
    });
  }

  // initial load once
  refreshVisits(Number(rangeSelect?.value || 7));

  // Optional: add a small manual refresh button if you want
  // document.getElementById("refreshBtn")?.addEventListener("click", () => refreshVisits(Number(rangeSelect?.value || 7)));

  // Defensive: stop external scripts from triggering page reloads on scroll
  // If some third-party script still attaches handlers, remove them repeatedly (last resort)
  setInterval(() => {
    try { window.onscroll = null; window.removeEventListener('scroll', window._insightsAutoScrollFetcher); } catch(e) {}
  }, 2000);

</script>
<script>
/*
  Robust range selector wiring
  - Works if <select id="rangeSelect"> options are:
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
    OR if values are not numeric, it will parse the visible text ("Last 30 days") to extract the number.
  - Debounces fast changes.
  - Calls refresh(days) (use refreshVisits if your code uses that name).
*/

// Name of your refresh function used elsewhere on page
const REFRESH_FN_NAME = "refresh"; // set to "refreshVisits" if that's what you used

// safe reference to refresh function
const callRefresh = (days) => {
  if (typeof window[REFRESH_FN_NAME] === "function") {
    window[REFRESH_FN_NAME](days);
  } else if (typeof window.refreshVisits === "function") {
    window.refreshVisits(days);
  } else {
    console.warn("No refresh function found. Expected window." + REFRESH_FN_NAME + " or window.refreshVisits");
  }
};

// parse numeric days from either value or visible text
function parseDaysFromOption(opt) {
  if (!opt) return 7;
  const v = (opt.value || opt.text || "").toString().trim();

  // if numeric value
  if (/^\d+$/.test(v)) return parseInt(v, 10);

  // fallback: extract first number from visible text (e.g., "Last 30 days")
  const m = v.match(/(\d{1,3})/);
  if (m) return parseInt(m[1], 10);

  return 7; // default
}

function setupRangeSelector() {
  const sel = document.getElementById("rangeSelect");
  if (!sel) {
    // try to find a select by name or class
    const alt = document.querySelector("select[name='rangeSelect'], select.range-select, select[data-range]");
    if (alt) {
      alt.id = "rangeSelect"; // normalize
    } else {
      console.warn("Range select not found (id=rangeSelect).");
      return;
    }
  }

  const range = document.getElementById("rangeSelect");

  // ensure options have numeric values if possible (normalize DOM)
  for (const opt of Array.from(range.options)) {
    const numeric = parseDaysFromOption(opt);
    // If option has non-numeric value, set a numeric value so subsequent reads are simple
    if (!/^\d+$/.test(opt.value)) {
      opt.value = String(numeric);
    }
  }

  // Debounce setup
  let debounceTimer = null;
  const DEBOUNCE_MS = 250;

  function onChangeHandler(e) {
    // read the numeric value safely
    const days = parseInt(e.target.value, 10) || 7;
    // debounce the actual refresh
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      callRefresh(days);
      debounceTimer = null;
    }, DEBOUNCE_MS);
  }

  // Remove any duplicate handlers first (defensive)
  range.removeEventListener("change", onChangeHandler);
  range.addEventListener("change", onChangeHandler);

  // If page already loaded and value is present, trigger initial refresh
  // But do so slightly after load to let other page init complete
  setTimeout(() => {
    const initialDays = parseInt(range.value, 10) || parseDaysFromOption(range.options[range.selectedIndex]);
    callRefresh(initialDays);
  }, 80);
}

// Wait for DOM ready if needed, then run setup
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", setupRangeSelector);
} else {
  setupRangeSelector();
}
</script>


</body>
</html>
