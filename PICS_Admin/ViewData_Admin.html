<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>View Data</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
:root{--accent:#6366f1;--accent-2:#eef2ff;--muted:#6b7280}
.page-wrap { padding: 20px 30px; }
.back-link { color: #1d4ed8; font-size: 16px; text-decoration: underline; cursor: pointer; padding-left: 5px; }
.back-link:hover { color: #1e40af; text-decoration-thickness: 2px; }
.top-title { font-size: 22px; font-weight: 600; margin-top: 10px; margin-bottom: 12px; }
.grid-wrapper { width: 100%; overflow-x: auto; overflow-y: auto; max-height: 650px; border: 1px solid #d1d5db; border-radius: 12px; background: #f8fafc; box-shadow: 0 6px 18px rgba(99,102,241,0.06); }
.table thead th { position: sticky; top: 0; background: var(--accent-2); color: var(--accent); font-weight: 700; z-index: 10; border-bottom: 2px solid rgba(99,102,241,0.15); }
.table tbody tr:nth-child(even) { background: #ffffff; }
.table tbody tr:hover { background: #eef2ff; }
.filter-box { width: 100%; }
.header-cell { display:flex; gap:6px; align-items:center; }
.filter-icon { width:18px; height:18px; display:inline-block; cursor:pointer; border-radius:3px; padding:2px; }
.filter-icon svg { display:block; }
/* filter popup */
.filter-popup { position:absolute; min-width:220px; background:#fff; border:1px solid #e6e9f8; box-shadow:0 8px 24px rgba(15,23,42,0.08); border-radius:8px; padding:12px; z-index:9999; }
.filter-popup .btn-apply { background:#10b981; color:#fff; border:none; padding:6px 12px; border-radius:6px; }
.filter-popup .btn-cancel { background:#fff; border:1px solid #e6e9f8; padding:6px 12px; border-radius:6px; margin-left:8px; }
.small-muted { color:var(--muted); font-size:13px }
/* spinner */
.loader-wrap { position:relative; }
.loader { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.6); z-index:50; }
/* pagination */
.pagination { padding:10px; display:flex; gap:8px; align-items:center; justify-content:flex-end; }
.page-btn { border:1px solid #e6e9f8; background:#fff; padding:6px 10px; border-radius:6px; cursor:pointer }
.page-btn.disabled { opacity:0.5; cursor:not-allowed }
.no-records { padding:20px; text-align:center; color:var(--muted); }
</style>
</head>
<body>

<div class="page-wrap">
    <button class="back-link" onclick="goBack()">← Back</button>
    <div class="top-title">View Data</div>

    <div class="grid-wrapper loader-wrap">
        <div id="loader" class="loader" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
        <table id="dataTable" class="table table-bordered table-hover align-middle mb-0">
            <thead>
                <tr id="headerRow">
                    <!-- headers generated by JS to keep markup tidy -->
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically here -->
            </tbody>
        </table>
        <div id="noRecords" class="no-records" style="display:none;">No records found</div>
    </div>

    <div class="pagination" id="paginationControls">
        <div class="small-muted">Rows per page:</div>
        <select id="pageSize" style="width:70px;" class="form-select form-select-sm">
            <option>10</option><option>25</option><option>50</option>
        </select>
        <div style="flex:1"></div>
        <button id="prevPage" class="page-btn">Prev</button>
        <span id="pageInfo" class="small-muted"></span>
        <button id="nextPage" class="page-btn">Next</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const COLUMNS = [
  'TrackingNumber','Submittedby','DateofSubmission','Status','Type','CustomerName','DocumentDetails','GeneralComments','phoneno','PaymentMode','TotalAmount','UaeDeliveryCharges','AdvancePaid','Balance','PassportNumber','SubmittedDocument1','SubmittedDocument2','SubmittedDocument3','OtherDocs','UaeNumberReleasingDate','PassCode','DateProcess','Delivered','Submitted','TYPE','COUNTRY'
];
// readable labels
const LABELS = {
  TrackingNumber:'Tracking Number', Submittedby:'Submitted By', DateofSubmission:'Date of Submission', Status:'Status', Type:'Type', CustomerName:'Customer Name', DocumentDetails:'Document Details', GeneralComments:'General Comments', phoneno:'Phone No', PaymentMode:'Payment Mode', TotalAmount:'Total Amount', UaeDeliveryCharges:'UAE Delivery Charges', AdvancePaid:'Advance Paid', Balance:'Balance', PassportNumber:'Passport Number', SubmittedDocument1:'Submitted Document 1', SubmittedDocument2:'Submitted Document 2', SubmittedDocument3:'Submitted Document 3', OtherDocs:'Other Docs', UaeNumberReleasingDate:'UAE Number Releasing Date', PassCode:'Pass Code', DateProcess:'Date Process', Delivered:'Delivered', Submitted:'Submitted', TYPE:'TYPE', COUNTRY:'COUNTRY'
};

let rawData = [];
let filteredData = [];
let currentPage = 1; let pageSize = 10; let sortField = null; let sortDir = 1; // 1 asc, -1 desc
let filters = {}; // { field: { method:'contains', value:'abc' } }

// build header row with filter icons
function buildHeader() {
  const header = document.getElementById('headerRow');
  header.innerHTML = '';
  COLUMNS.forEach(col => {
    const th = document.createElement('th');
    th.dataset.field = col;
    th.className = 'text-start';
    th.innerHTML = `<div class="header-cell"><div style="flex:1">${LABELS[col]}</div>
      <div class="filter-icon" title="Filter" data-field="${col}">
        <!-- funnel icon (Option A) -->
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 5h18M6 12h12M10 19h4" stroke="#4f46e5" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>`;

    // sorting on header click
    th.addEventListener('click', (e)=>{
      if (e.target.closest('.filter-icon')) return; // ignore clicks on icon
      const field = th.dataset.field;
      if (sortField === field) sortDir *= -1; else { sortField = field; sortDir = 1; }
      applyAll();
    });

    // filter icon click
    th.querySelector('.filter-icon').addEventListener('click', (ev)=>{
      ev.stopPropagation(); openFilterPopup(ev.currentTarget, col);
    });

    header.appendChild(th);
  });
}

// open popup next to the icon
function openFilterPopup(iconEl, field) {
  closeFilterPopup();
  const rect = iconEl.getBoundingClientRect();

  const popup = document.createElement('div');
  popup.className = 'filter-popup';
  popup.style.top = (window.scrollY + rect.bottom + 6) + 'px';
  popup.style.left = (rect.left) + 'px';
  popup.innerHTML = `
    <div class="small-muted">Filter by condition</div>
    <div style="margin-top:8px">
      <select id="f_method" class="form-select form-select-sm">
        <option value="contains">Contains</option>
        <option value="equals">Equals</option>
        <option value="starts">Starts With</option>
        <option value="ends">Ends With</option>
      </select>
      <input id="f_value" class="form-control form-control-sm" style="margin-top:8px" placeholder="Enter value">
    </div>
    <div style="margin-top:10px; text-align:right">
      <button id="f_apply" class="btn-apply">Apply</button>
      <button id="f_cancel" class="btn-cancel">Cancel</button>
    </div>
  `;
  document.body.appendChild(popup);

  // set existing values if present
  const existing = filters[field];
  if (existing) {
    popup.querySelector('#f_method').value = existing.method;
    popup.querySelector('#f_value').value = existing.value;
  }

  popup.querySelector('#f_apply').addEventListener('click', ()=>{
    const method = popup.querySelector('#f_method').value;
    const value = popup.querySelector('#f_value').value.trim();
    if (value === '') { delete filters[field]; } else { filters[field] = { method, value }; }
    closeFilterPopup(); applyAll();
  });
  popup.querySelector('#f_cancel').addEventListener('click', ()=>{ closeFilterPopup(); });

  // close on outside click
  setTimeout(()=>{ window.addEventListener('click', outsideClick); }, 50);
  function outsideClick(e){ if (!popup.contains(e.target) && !iconEl.contains(e.target)) { closeFilterPopup(); } }
  popup._outside = outsideClick;
  popup._field = field;
}
function closeFilterPopup(){ const p = document.querySelector('.filter-popup'); if (p){ window.removeEventListener('click', p._outside); p.remove(); } }

function showLoader(show){ document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

async function loadGridData(){
  showLoader(true);
  try{
    const response = await fetch('https://script.google.com/macros/s/AKfycbwNs3TXb2p8xDxPv4uZ5sKDYRncOm7v695XzRN7Qlv7qw9x7qJwWzjljd4E0QgVC6MkSw/exec', { // replace with  Apps Script URL when deploy
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ action: 'getData' })
    });

    // basic validation
    if (!response.ok) throw new Error('Network response not ok: ' + response.status);
    const json = await response.json();
    if (!Array.isArray(json)) throw new Error('Invalid response: expected JSON array');

    rawData = json;
    currentPage = 1;
    applyAll();
  }catch(err){
    console.error('Error loading data', err);
    rawData = [];
    applyAll();
  }finally{ showLoader(false); }
}

function applyAll(){
  // filter
  filteredData = rawData.filter(r => {
    for (const f in filters){
      const val = (r[f] ?? '').toString();
      const method = filters[f].method; const target = filters[f].value.toString();
      if (method === 'contains' && !val.toLowerCase().includes(target.toLowerCase())) return false;
      if (method === 'equals' && val.toLowerCase() !== target.toLowerCase()) return false;
      if (method === 'starts' && !val.toLowerCase().startsWith(target.toLowerCase())) return false;
      if (method === 'ends' && !val.toLowerCase().endsWith(target.toLowerCase())) return false;
    }
    return true;
  });

  // sort
  if (sortField){ filteredData.sort((a,b)=>{
    const A = (a[sortField] ?? '').toString(); const B = (b[sortField] ?? '').toString();
    return A.localeCompare(B, undefined, {numeric:true}) * sortDir;
  }); }

  renderTable();
}

function renderTable(){
  const tbody = document.querySelector('#dataTable tbody'); tbody.innerHTML = '';
  pageSize = parseInt(document.getElementById('pageSize').value || '10');
  const total = filteredData.length;
  const pages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > pages) currentPage = pages;
  const start = (currentPage-1)*pageSize; const end = start + pageSize;
  const pageRows = filteredData.slice(start,end);

  if (pageRows.length === 0){ document.getElementById('noRecords').style.display = 'block'; document.getElementById('dataTable').style.display='none'; }
  else { document.getElementById('noRecords').style.display = 'none'; document.getElementById('dataTable').style.display='table'; }

  pageRows.forEach(row => {
    const tr = document.createElement('tr');
    const tds = COLUMNS.map(c => `<td>${escapeHtml(row[c] ?? '')}</td>`).join('');
    tr.innerHTML = tds; tbody.appendChild(tr);
  });

  document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${pages} — ${total} records`;
  document.getElementById('prevPage').classList.toggle('disabled', currentPage===1);
  document.getElementById('nextPage').classList.toggle('disabled', currentPage===pages);
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// pagination handlers
document.getElementById('prevPage').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; renderTable(); } });
document.getElementById('nextPage').addEventListener('click', ()=>{ const total = filteredData.length; const pages = Math.max(1, Math.ceil(total/pageSize)); if (currentPage<pages){ currentPage++; renderTable(); } });
document.getElementById('pageSize').addEventListener('change', ()=>{ currentPage=1; renderTable(); });

function goBack(){ window.location.href = 'Dashboard_Admin.html'; }

// init
buildHeader(); loadGridData();
</script>
</body>
</html>