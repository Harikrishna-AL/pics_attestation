<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f8;
    }
   #sessionTimer {
  display: inline-block;
  background: white;
  padding: 6px 18px;
  border-radius: 999px;
  font-size: 14px;
  font-weight: 600;
  color: #2563eb;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  border: 1px solid #e5e7eb;

  margin-left: 40px;  
}

.side-pill-btn {
  position: fixed;
  left: -5px;
  transform: translateY(-50%) rotate(180deg);
  
  background: #ffffff;
  color: #2563eb;
  font-weight: 600;
  padding: 10px 14px;
  
  border-radius: 50px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);

  writing-mode: vertical-rl;
  text-orientation: mixed;

  font-size: 14px;
  letter-spacing: 0.5px;

  cursor: pointer;
  z-index: 9999;
  transition: 0.25s ease;
}

/* individual spacing */
#insertVerticalBtn {
  top: 40%;
}

#ViewDataVerticalBtn {
  top: 55%;
}


.side-pill-btn:hover {
  background: #f3f4f6;
  transform: translateY(-50%) rotate(180deg) scale(1.07);
}

    .header {
      background: #0072ff;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }

    .logout-btn {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: #ff4d4f;
      border: none;
      color: white;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
    }

    .content {
      padding: 30px;
      text-align: center;
      color: #333;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <div class="header">
    PICS Dashboard
    <button class="logout-btn" id="logoutBtn">Logout</button>
      <span id="sessionTimer" style="margin-left:10px; font-weight:600; color:#444444;"></span>

  </div>

  
  <div id="insertVerticalBtn" class="side-pill-btn">
  <span>Insert Data</span>
</div>
 <div id="ViewDataVerticalBtn" class="side-pill-btn">
  <span>View Data</span>
</div>
<script>
document.getElementById("insertVerticalBtn").addEventListener("click", () => {
  
    window.location.href = "Insert_Admin.html";  // new page
});
document.getElementById("ViewDataVerticalBtn").addEventListener("click", () => {
  
    window.location.href = "ViewData_Admin.html";  // new page
});


</script>



  <div class="content">
   <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attestation Web Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      background: #f4f7fb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .form-label {
  font-weight: 500 !important;
}
    .top-bar {
      background: #007bff;
      color: #fff;
      padding: 14px 30px;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    .top-bar .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .avatar-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #0056b3;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .page-wrap {
      padding: 20px 24px 40px;
    }

    .hero-card {
      border-radius: 16px;
      background: linear-gradient(90deg, #4f46e5, #3b82f6, #ec4899);
      color: #fff;
      padding: 18px 22px;
      margin-bottom: 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 15px 30px rgba(15, 23, 42, 0.35);
    }
    .hero-card h2 {
      font-size: 22px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .hero-card small {
      opacity: 0.9;
    }
    .pill-tabs button {
      border-radius: 999px;
      border: 0;
      padding: 6px 18px;
      margin-left: 8px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }
    .pill-tabs button.active {
      background: #fff;
      color: #1d4ed8;
      font-weight: 600;
    }

    .filter-row {
      margin-bottom: 12px;
      gap: 10px;
    }
    .filter-row label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .kpi-card {
      border-radius: 16px;
      padding: 16px 18px;
      border: 0;
      color: #fff;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.25);
    }
    .kpi-title {
      font-size: 13px;
      text-transform: uppercase;
      opacity: 0.85;
    }
    .kpi-value {
      font-size: 26px;
      font-weight: 700;
      margin: 6px 0 0;
    }
    .kpi-sub {
      font-size: 12px;
      opacity: 0.9;
    }

    .panel-card {
      border-radius: 16px;
      background: #ffffff;
      border: 0;
      padding: 14px 16px 10px;
      height: 330px;
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.12);
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .panel-title {
      font-size: 14px;
      font-weight: 600;
    }
    .panel-subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .quick-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 8px;
      margin: 2px;
    }
    .table-wrap {
      height: 260px;
      overflow-y: auto;
    }

    .bottom-panel {
      height: 320px;
    }

    canvas {
      max-height: 250px;
    }
    .form-label {
  color: #212529 !important; /* bootstrap default */
}

  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="top-bar">
    <div class="brand">
      <div class="avatar-circle">AT</div>
      <div>
        <div>PICS Attestation Web Analytics</div>
         <!-- <small>Operations &amp; Customer Overview</small>-->
      </div>
    </div>
   
  </div>

  <div class="page-wrap container-fluid">
    <!-- Hero card -->
    <div class="hero-card">
      <div>
        <h2>Track submissions, revenue and customer cases in real time</h2>
      </div>
      <div class="pill-tabs">
        
        <button class="active">Overview</button>
        <button onclick="openkpi()">KPI</button>
        <button>Revenue</button>
        <button>Countries</button>
      </div>
    </div>

    <!-- Filters -->
   <!-- FILTER ROW 1: 4 columns in a line -->
<div class="row filter-row g-3 mb-3">

  <div class="col-lg-3 col-md-6 col-12">
    <label for="fromDate">From date</label>
    <input type="date" id="fromDate" class="form-control form-control-sm" />
  </div>

  <div class="col-lg-3 col-md-6 col-12">
    <label for="toDate">To date</label>
    <input type="date" id="toDate" class="form-control form-control-sm" />
  </div>

  <div class="col-lg-3 col-md-6 col-12">
    <label for="statusFilter">Status</label>
    <select id="statusFilter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>

  <div class="col-lg-3 col-md-6 col-12">
    <label class="form-label fw-semibold">Year</label>
    <select id="yearFilter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>

</div>


      
   

 <div class="row g-3 align-items-end mb-3">

  <div class="col-xl-2 col-lg-3 col-md-4 col-6">
    <label class="form-label">Country</label>
    <select id="countryFilter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>

 

  <div class="col-xl-2 col-lg-3 col-md-4 col-6">
    <label class="form-label">Type</label>
    <select id="typeFilter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>

  <div class="col-xl-3 col-lg-3 col-md-4 col-6">
    <label class="form-label">Customer</label>
    <select id="customerFilter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>

  <div class="col-xl-3 col-lg-3 col-md-4 col-6">
    <label class="form-label">Payment</label>
    <select id="paymentFilter" class="form-select form-select-sm">
      <option value="">All</option>
    </select>
  </div>

</div>



    <!-- KPI cards -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="kpi-card" style="background: linear-gradient(135deg,#8b5cf6,#6366f1);">
          <div class="kpi-title">Total Documents</div>
          <div id="kpi-total-cases" class="kpi-value">0</div>
          <div class="kpi-sub">All tracking numbers</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card" style="background: linear-gradient(135deg,#22c55e,#16a34a);">
          <div class="kpi-title">Delivered</div>
          <div id="kpi-delivered" class="kpi-value">0</div>
          <div class="kpi-sub">Marked as delivered</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card" style="background: linear-gradient(135deg,#0ea5e9,#2563eb);">
          <div class="kpi-title">Total Amount</div>
          <div id="kpi-total-amount" class="kpi-value">₹0</div>
          <div class="kpi-sub">Sum of TotalAmount</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card" style="background: linear-gradient(135deg,#fb923c,#ef4444);">
          <div class="kpi-title">Balance Pending</div>
          <div id="kpi-balance" class="kpi-value">₹0</div>
          <div class="kpi-sub">Outstanding Balance</div>
        </div>
      </div>
    </div>

    <!-- Upper middle charts -->
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title">Status breakdown</div>
              <div class="panel-subtitle">By Status</div>
            </div>
          </div>
          <canvas id="statusChart"></canvas>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title">Documents by Country</div>
              <div class="panel-subtitle">Top countries</div>
            </div>
          </div>
          <canvas id="countryChart"></canvas>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel-card">
          <div class="panel-header">
            <div>
              <div class="panel-title">Payment Modes</div>
              <div class="panel-subtitle">Count of cases</div>
            </div>
          </div>
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Quick overview + dimensions -->
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="panel-card bottom-panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">Quick overview</div>
              <div class="panel-subtitle">Dimensions in your sheet</div>
            </div>
          </div>
          <div class="mt-2">
            <!-- All your fields as small pills -->
            <span class="badge bg-light text-secondary quick-badge">TrackingNumber</span>
            <span class="badge bg-light text-secondary quick-badge">Submittedby</span>
            <span class="badge bg-light text-secondary quick-badge">DateofSubmission</span>
            <span class="badge bg-light text-secondary quick-badge">Status</span>
            <span class="badge bg-light text-secondary quick-badge">Type</span>
            <span class="badge bg-light text-secondary quick-badge">Customer Name</span>
            <span class="badge bg-light text-secondary quick-badge">DocumentDetails</span>
            <span class="badge bg-light text-secondary quick-badge">General Comments</span>
            <span class="badge bg-light text-secondary quick-badge">phoneno</span>
            <span class="badge bg-light text-secondary quick-badge">PaymentMode</span>
            <span class="badge bg-light text-secondary quick-badge">TotalAmount</span>
            <span class="badge bg-light text-secondary quick-badge">UaeDeliveryCharges</span>
            <span class="badge bg-light text-secondary quick-badge">AdvancePaid</span>
            <span class="badge bg-light text-secondary quick-badge">Balance</span>
            <span class="badge bg-light text-secondary quick-badge">PassportNumber</span>
            <span class="badge bg-light text-secondary quick-badge">SubmittedDocument1</span>
            <span class="badge bg-light text-secondary quick-badge">SubmittedDocument2</span>
            <span class="badge bg-light text-secondary quick-badge">SubmittedDocument3</span>
            <span class="badge bg-light text-secondary quick-badge">Other Docs</span>
            <span class="badge bg-light text-secondary quick-badge">UAE NUMBER RELEASING DATE</span>
            <span class="badge bg-light text-secondary quick-badge">DateProcess</span>
            <span class="badge bg-light text-secondary quick-badge">Delivered</span>
            <span class="badge bg-light text-secondary quick-badge">Submitted</span>
            <span class="badge bg-light text-secondary quick-badge">COUNTRY</span>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel-card bottom-panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">Monthly submissions</div>
              <div class="panel-subtitle">By Date of Submission</div>
            </div>
          </div>
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel-card bottom-panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">Total Amount by TYPE</div>
              <div class="panel-subtitle">Service type</div>
            </div>
          </div>
          <canvas id="typeAmountChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Recent submissions table -->
    <div class="row g-3">
      <div class="col-md-12">
        <div class="panel-card">
          <div class="panel-header">
            <div class="panel-title">Recent submissions</div>
            <div class="panel-subtitle">Last 8 rows</div>
          </div>
          <div class="table-wrap">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Tracking #</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Customer</th>
                  <th>Country</th>
                  <th>Total Amount</th>
                  <th>Payment Mode</th>
                </tr>
              </thead>
              <tbody id="recentTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const excelUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNdL-odS32YpWW70Zjko2amZg5duTOyf1e7UK-5Z7JTjdousVV09S4Nj8T4NvDcGYEr95KtIx1otBy/pub?output=csv";

    // ---------- STATE ----------
    let allData = [];
    let statusChart, countryChart, paymentChart, monthlyChart, typeAmountChart;

    // ---------- HELPERS ----------
    function parseNumber(val) {
      if (!val) return 0;
      const num = parseFloat(String(val).replace(/[,₹]/g, ""));
      return isNaN(num) ? 0 : num;
    }

    function formatCurrency(val) {
      return "₹" + val.toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }

   
    function parseDateSmart(v) {
  if (!v) return null;

  let s = v.toString().trim();

  // replace bad characters
  s = s.replace(/[^0-9.\-\/]/g, "");

  // convert all separators to "."
  s = s.replace(/[-\/]/g, ".");

  const parts = s.split(".");
  if (parts.length < 3) return null;

  let [dd, mm, yyyy] = parts;

  dd = parseInt(dd);
  mm = parseInt(mm);

  // fix 2-digit year (25 → 2025)
  if (yyyy.length === 2) yyyy = "20" + yyyy;

  yyyy = parseInt(yyyy);

  if (!dd || !mm || !yyyy) return null;

  return new Date(yyyy, mm - 1, dd);
}




    function cleanCountry(raw) {
  if (!raw) return "Unknown";

  const text = raw.toString().toUpperCase();

  if (text.includes("UAE")) return "UAE";
  if (text.includes("QATAR")) return "QATAR";
  if (text.includes("KUWAIT")) return "KUWAIT";
  if (text.includes("OMAN")) return "OMAN";
  if (text.includes("ITALY")) return "ITALY";
  if (text.includes("SAUDI")) return "SAUDI";

  const words = text.split(" ");
  return words.slice(0, 2).join(" ");
}
function trimValue(v) {
  if (v === null || v === undefined) return "";
  return v.toString().trim();
}


    function groupCount(data, field) {
      const map = {};
      data.forEach((row) => {
        const key = (row[field] || "Unknown").toString().trim() || "Unknown";
        map[key] = (map[key] || 0) + 1;
      });
      return map;
    }

    function groupSum(data, groupField, valueField) {
      const map = {};
      data.forEach((row) => {
        const key = (row[groupField] || "Unknown").toString().trim() || "Unknown";
        const val = parseNumber(row[valueField]);
        map[key] = (map[key] || 0) + val;
      });
      return map;
    }

    function uniqueValues(data, field) {
      const set = new Set();
      data.forEach((row) => {
        const v = (row[field] || "").toString().trim();
        if (v) set.add(v);
      });
      return Array.from(set).sort();
    }

   function applyFilters() {
  const fromDateVal = document.getElementById("fromDate").value;
  const toDateVal = document.getElementById("toDate").value;

  const statusVal = document.getElementById("statusFilter").value;
  const countryVal = document.getElementById("countryFilter").value;
  const typeVal = document.getElementById("typeFilter").value;
  const customerVal = document.getElementById("customerFilter").value;
  const paymentVal = document.getElementById("paymentFilter").value;
  const yearVal = document.getElementById("yearFilter").value;

  const fromDate = fromDateVal ? new Date(fromDateVal) : null;
  const toDate = toDateVal ? new Date(toDateVal) : null;
  if (fromDate) fromDate.setHours(0, 0, 0, 0);
if (toDate)   toDate.setHours(23, 59, 59, 999);

  const filtered = allData.filter((row) => {
    let pass = true;

    const d = parseDateSmart(row["DateofSubmission"]);

    // skip invalid dates
    if (!d) return false;

    // date range compare
    if (fromDate && d < fromDate) pass = false;
    if (toDate && d > toDate) pass = false;

    // year filter
    if (yearVal && d.getFullYear().toString() !== yearVal) pass = false;

    // other filters
    if (statusVal && row["Status"] !== statusVal) pass = false;
    if (countryVal && row["COUNTRY"] !== countryVal) pass = false;
    if (typeVal && row["Type"] !== typeVal) pass = false;
    if (customerVal && row["Customer Name"] !== customerVal) pass = false;
    if (paymentVal && row["PaymentMode"] !== paymentVal) pass = false;

    return pass;
  });

  // finally clean country
  filtered.forEach(r => {
    r.COUNTRY = cleanCountry(r.COUNTRY);
  });

  return filtered;
}



    function updateKpis(filtered) {
      const totalCases = filtered.length;
      const deliveredCount = filtered.filter((row) => {
        const d = (row["Delivered"] || "").toString().toLowerCase();
        return d === "y" || d === "yes" || d === "delivered";
      }).length;
      const totalAmountSum = filtered.reduce(
        (sum, row) => sum + parseNumber(row["TotalAmount"]),
        0
      );
      const balanceSum = filtered.reduce(
        (sum, row) => sum + parseNumber(row["Balance"]),
        0
      );

      document.getElementById("kpi-total-cases").textContent = totalCases.toLocaleString();
      document.getElementById("kpi-delivered").textContent =
        deliveredCount.toLocaleString();
      document.getElementById("kpi-total-amount").textContent =
        formatCurrency(totalAmountSum);
      document.getElementById("kpi-balance").textContent = formatCurrency(balanceSum);
    }

    function renderCharts(filtered) {

  // ---------------- STATUS CHART ----------------
  const statusMap = groupCount(filtered, "Status");
  const statusLabels = Object.keys(statusMap);
  const statusValues = Object.values(statusMap);

  if (!statusChart) {
    statusChart = new Chart(document.getElementById("statusChart"), {
      type: "doughnut",
      data: { labels: statusLabels, datasets: [{ data: statusValues }] },
      options: { plugins: { legend: { position: "bottom" } } }
    });
  } else {
    statusChart.data.labels = statusLabels;
    statusChart.data.datasets[0].data = statusValues;
    statusChart.update();
  }

  // ---------------- COUNTRY CHART ----------------
  const countryMap = groupCount(filtered, "COUNTRY");
  const countryLabels = Object.keys(countryMap);
  const countryValues = Object.values(countryMap);

  if (!countryChart) {
    countryChart = new Chart(document.getElementById("countryChart"), {
      type: "bar",
      data: { labels: countryLabels, datasets: [{ data: countryValues }] },
      options: {
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { autoSkip: false } } }
      }
    });
  } else {
    countryChart.data.labels = countryLabels;
    countryChart.data.datasets[0].data = countryValues;
    countryChart.update();
  }

  // ---------------- PAYMENT MODE CHART ----------------
  const payMap = groupCount(filtered, "PaymentMode");
  const payLabels = Object.keys(payMap);
  const payValues = Object.values(payMap);

  if (!paymentChart) {
    paymentChart = new Chart(document.getElementById("paymentChart"), {
      type: "pie",
      data: { labels: payLabels, datasets: [{ data: payValues }] },
      options: { plugins: { legend: { position: "bottom" } } }
    });
  } else {
    paymentChart.data.labels = payLabels;
    paymentChart.data.datasets[0].data = payValues;
    paymentChart.update();
  }

  // ---------------- MONTHLY SUBMISSIONS (UPDATED) ----------------
  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

  // Create an array of 12 months
  let monthCounts = Array(12).fill(0);

  // Selected year from dropdown
  const selectedYear = document.getElementById("yearFilter")
    ? document.getElementById("yearFilter").value
    : "";

  filtered.forEach(row => {
    const d = toDate(row["DateofSubmission"]);
    if (!d) return;

    // If year filter selected → only count that year
    if (selectedYear && d.getFullYear().toString() !== selectedYear) return;

    const monthIndex = d.getMonth(); // 0-11
    monthCounts[monthIndex]++;
  });

  const monthLabels = monthNames;
  const monthValues = monthCounts;

  if (!monthlyChart) {
    monthlyChart = new Chart(document.getElementById("monthlyChart"), {
      type: "line",
      data: { labels: monthLabels, datasets: [{ data: monthValues }] },
      options: {
        plugins: { legend: { display: false } },
        tension: 0.3
      }
    });
  } else {
    monthlyChart.data.labels = monthLabels;
    monthlyChart.data.datasets[0].data = monthValues;
    monthlyChart.update();
  }

  // ---------------- AMOUNT BY TYPE ----------------
  const typeMap = groupSum(filtered, "TYPE", "TotalAmount");
  const typeLabels = Object.keys(typeMap);
  const typeValues = Object.values(typeMap);

  if (!typeAmountChart) {
    typeAmountChart = new Chart(document.getElementById("typeAmountChart"), {
      type: "bar",
      data: { labels: typeLabels, datasets: [{ data: typeValues }] },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { ticks: { callback: (v) => v / 1000 + "k" } } }
      }
    });
  } else {
    typeAmountChart.data.labels = typeLabels;
    typeAmountChart.data.datasets[0].data = typeValues;
    typeAmountChart.update();
  }
}


    function renderRecentTable(filtered) {
      const tbody = document.getElementById("recentTableBody");
      tbody.innerHTML = "";
      const lastRows = filtered.slice(-8); // last 8 records
      lastRows.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row["TrackingNumber"] || "-"}</td>
          <td>${row["DateofSubmission"] || "-"}</td>
          <td>${row["Status"] || "-"}</td>
          <td>${row["CustomerName"] || "-"}</td>
          <td>${row["COUNTRY"] || "-"}</td>
          <td>${formatCurrency(parseNumber(row["TotalAmount"]))}</td>
          <td>${row["PaymentMode"] || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function populateFilters() {
      const statusSel = document.getElementById("statusFilter");
      const countrySel = document.getElementById("countryFilter");

      uniqueValues(allData, "Status").forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        statusSel.appendChild(opt);
      });

      uniqueValues(allData, "COUNTRY").forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        countrySel.appendChild(opt);
      });
    }

    function populateExtraFilters() {
  const typeSel = document.getElementById("typeFilter");
  const custSel = document.getElementById("customerFilter");
  const paySel = document.getElementById("paymentFilter");

  // Unique values
  const types = uniqueValues(allData, "Type");
  const customers = uniqueValues(allData, "Customer Name");
  const payments = uniqueValues(allData, "PaymentMode");

  types.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    typeSel.appendChild(opt);
  });

  customers.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    custSel.appendChild(opt);
  });

  payments.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    paySel.appendChild(opt);
  });
}

function toDate(value) {
  if (!value) return null;

  // Remove extra spaces
  value = value.toString().trim();

  // Accept DD-MM-YYYY or DD/MM/YYYY
  const parts = value.split(/[-\/]/);

  if (parts.length !== 3) return null;

  let [dd, mm, yyyy] = parts.map(x => parseInt(x, 10));

  // Validate numbers
  if (!dd || !mm || !yyyy) return null;

  // Convert to proper JS date
  const dateObj = new Date(yyyy, mm - 1, dd);

  // Handle invalid date (e.g., 32-13-2025)
  if (isNaN(dateObj.getTime())) return null;

  return dateObj;
}


function populateYearFilter() {
  const yearSel = document.getElementById("yearFilter");
  const years = new Set();

  allData.forEach(row => {
    const d = toDate(row["DateofSubmission"]);
    if (d) years.add(d.getFullYear());
  });

  Array.from(years).sort().forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSel.appendChild(opt);
  });
}


    function refreshDashboard() {
      const filtered = applyFilters();
      updateKpis(filtered);
      renderCharts(filtered);
      renderRecentTable(filtered);
    }

    // ---------- INIT ----------
    fetch(excelUrl)
      .then((res) => res.text())
      .then((csvText) => {
        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true
        });
        allData = parsed.data;
        populateFilters();
        populateExtraFilters();
        populateYearFilter();
        refreshDashboard();
      })
      .catch((err) => console.error("Error loading CSV:", err));

    document.getElementById("fromDate").addEventListener("change", refreshDashboard);
    document.getElementById("toDate").addEventListener("change", refreshDashboard);
    document.getElementById("statusFilter").addEventListener("change", refreshDashboard);
    document.getElementById("countryFilter").addEventListener("change", refreshDashboard);
    document.getElementById("typeFilter").addEventListener("change", refreshDashboard);
document.getElementById("customerFilter").addEventListener("change", refreshDashboard);
document.getElementById("paymentFilter").addEventListener("change", refreshDashboard);
document.getElementById("yearFilter").addEventListener("change", refreshDashboard);


  </script>
</body>
</html>

  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Your global config -->
  <script src="supabaseConfig.js"></script>
  <script>
    // Protect dashboard page
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (!session) {
            window.location.href = "Login_Admin.html";
        }
    });

    // Logout functionality
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        if (error) {
            alert('Error logging out: ' + error.message);
        } else {
            window.location.href = "Login_Admin.html";
        }
    });

document.addEventListener("DOMContentLoaded", () => {

    // =========================
// SESSION TIMEOUT SYSTEM
// =========================

const SESSION_DURATION = 15 * 60;  

let remaining = SESSION_DURATION;
let timerInterval;

// Display timer beside logout button
const timerEl = document.getElementById("sessionTimer");

// Start countdown
function startSessionTimer() {
  updateTimerDisplay();

  timerInterval = setInterval(() => {
    remaining--;

    updateTimerDisplay();

    if (remaining <= 0) {
      clearInterval(timerInterval);
      sessionExpired();
    }
  }, 1000);
}

// Show mm:ss format
function updateTimerDisplay() {
  let min = Math.floor(remaining / 60);
  let sec = remaining % 60;
  timerEl.textContent = `Session expires in ${min}:${sec.toString().padStart(2, "0")}`;
}

// On timeout
function sessionExpired() {
  alert("Session timed out. Please login again.");

  // clear stored login data (if any)
  localStorage.removeItem("loginUser");
  sessionStorage.clear();

  // redirect to login
  window.location.href = "Login_Admin.html"; 
}

// Reset timer when user interacts
function resetTimer() {
  remaining = SESSION_DURATION;
  updateTimerDisplay();
}

// Listen to user activity
window.addEventListener("mousemove", resetTimer);
window.addEventListener("keydown", resetTimer);
window.addEventListener("click", resetTimer);
window.addEventListener("scroll", resetTimer);

// =========================
// HANDLE SESSION TIMEOUT
// =========================
async function handleSessionTimeout() {
  alert("Session timed out. Please login again.");

  await supabase.auth.signOut();

  window.location.href = "Login_Admin.html";
}

// Start timer on load
startSessionTimer();
    });

  </script>

<script>
  //tab button
const tabs = document.querySelectorAll(".pill-tabs button");
const sections = document.querySelectorAll(".tab-section");

tabs.forEach(btn => {
  btn.addEventListener("click", () => {

    // remove active class
    tabs.forEach(b => b.classList.remove("active"));

    // set active
    btn.classList.add("active");

    // hide all sections
    sections.forEach(sec => sec.style.display = "none");

    // show selected section
    const id = "tab-" + btn.textContent.trim().toLowerCase();
    document.getElementById(id).style.display = "block";
  });
});
</script>
<script>
//kpi section

function openkpi() {

    window.location.href = "Dashboard_KPI.html";   // new page
}
</script>



</body>
</html>
