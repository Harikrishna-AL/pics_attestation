<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="Assets/css/Admin_common.css">
<script src="Assets/js/message.js" defer></script>
<title>Mark Attendance</title>
<style>
  :root{
    --green:#1fb76a;
    --red:#e04b4b;
    --blue:#3388ff;
    --muted:#666;
    --card-bg:#fff;
  }
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:#ffffff; /* white background as requested */
    color:#222;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:24px;
  }

  .card{
    width:100%;
    max-width:560px;
    background:var(--card-bg);
    border-radius:12px;
    box-shadow:0 6px 24px rgba(20,30,60,0.08);
    padding:32px;
    text-align:center;
  }

  h1{
    margin:0 0 20px 0;
    font-size:28px;
    letter-spacing:0.4px;
  }

  .btn-row{
    display:flex;
    gap:18px;
    justify-content:center;
    margin-bottom:18px;
  }

  .btn{
    padding:14px 28px;
    border-radius:28px;
    border:0;
    color:#fff;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    transition:transform .08s ease, box-shadow .08s ease;
  }
  .btn:active{ transform:translateY(1px); }

  .btn.in{ background: linear-gradient(180deg, #2ecc71, var(--green)); box-shadow:0 10px 30px rgba(46,204,113,0.12); }
  .btn.out{ background: linear-gradient(180deg, #ff6b6b, var(--red)); box-shadow:0 10px 30px rgba(224,75,75,0.12); }

  .field{
    margin:14px 0;
    text-align:left;
  }
  label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin-bottom:6px;
  }
  input[type="text"], .display-box{
    width:100%;
    padding:12px 14px;
    border-radius:8px;
    border:1px solid #e6e6e6;
    font-size:14px;
    background:#fafafa;
    color:#111;
    box-sizing:border-box;
  }
  .row{
    display:flex;
    gap:12px;
    margin-top:10px;
  }
  .row .col{
    flex:1;
  }
  .small-box{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #e6e6e6;
    background:#fafafa;
    font-size:14px;
    justify-content:space-between;
  }
  .small-label{ font-size:12px; color:var(--muted); margin-bottom:6px; display:block; }
  .mark-btn{
    margin-top:20px;
    width:60%;
    max-width:320px;
    background:var(--blue);
    color:#fff;
    border-radius:28px;
    padding:12px 18px;
    border:0;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(51,136,255,0.16);
  }

  .note{ color:var(--muted); font-size:13px; margin-top:8px; }

  /* small responsive */
  @media (max-width:420px){
    .btn-row{ flex-direction:column; }
    .btn{ width:100%; }
    .mark-btn{ width:100%; }
  }
  .logout-btn {
    position: absolute;
    top: 15px;        /* place near top */
    right: 20px;      /* place at right */
    background: #ff4d4f;
    border: none;
    color: white;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 5px;
    z-index: 9999;    /* ensure stays above content */
}
body {
    padding-top: 20px; /* pushes content down so logout button won't overlap */
}
.topbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;

    background: white;
    display: flex;
    align-items: center;
    justify-content: space-between;

    padding: 0 15px; /* ⬅️ Adds space so button stays inside screen */
    box-sizing: border-box;

    border-bottom: 1px solid #eee;
    z-index: 999;
}

      .back-circle { background:#3a3a3a; color:#fff; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; box-shadow:0 4px 12px rgba(17,24,39,0.08); }
    .back-circle:hover { transform:translateY(-2px); background:#2b2b2b; }

    /* Saving modal styles */
.saving-modal { 
  display: none; /* hidden by default */
  position: fixed;
  inset: 0;
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

/* backdrop */
.saving-modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(2px);
}

/* content box */
.saving-modal__content {
  position: relative;
  z-index: 2;
  width: 320px;
  max-width: calc(100% - 32px);
  background: #ffffff;
  border-radius: 12px;
  padding: 20px 18px;
  box-shadow: 0 12px 40px rgba(2,6,23,0.15);
  display: flex;
  gap: 14px;
  align-items: center;
}

/* spinner */
.saving-modal__spinner {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  border: 5px solid rgba(0,0,0,0.08);
  border-top-color: #1976d2;
  animation: saving-spin 1s linear infinite;
}
@keyframes saving-spin { to { transform: rotate(360deg); } }

/* text */
.saving-modal__title {
  font-weight: 600;
  font-size: 16px;
  color: #111827;
}
.saving-modal__subtitle {
  font-size: 13px;
  color: #6b7280;
  margin-top: 6px;
}

/* utility: show modal */
.saving-modal.show { display: flex; }

</style>
</head>
<body>
  
<div class="topbar">
<button id="backBtn"class="back-circle" onclick="goBack()">←</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
</div>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Mark Attendance</h1>

    <div class="btn-row" role="group" aria-label="Punch controls">
      <button id="punchInBtn" class="btn in" type="button">PUNCH IN</button>
      <button id="punchOutBtn" class="btn out" type="button">PUNCH OUT</button>
    </div>

    <div class="field">
      <label for="employeeName"><b>Employee Name:</b></label>
<input id="employeeName" type="text" disabled />
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <label class="small-label"><b>Date</b></label>
        <div id="dateBox" class="small-box">-- / -- / ----</div>
      </div>
      <div class="col">
        <label class="small-label" id="timeLabel"><b>Punch In Time</b></label>
        <div id="timeBox" class="small-box">-- : -- --</div>
      </div>
    </div>

    <button id="markBtn" class="mark-btn" type="button">MARK</button>
    <div class="note" id="statusNote"></div>
  </div>
  <!-- Save modal (paste inside <body>) -->
<div id="savingModal" class="saving-modal" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
  <div class="saving-modal__backdrop"></div>
  <div class="saving-modal__content" role="document" aria-live="polite">
    <div class="saving-modal__spinner" aria-hidden="true"></div>
    <div class="saving-modal__text">
      <div class="saving-modal__title">Marking Attendance</div>
      <div class="saving-modal__subtitle">Please wait…</div>
    </div>
  </div>
</div>



<!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Your global config -->
  <script src="Assets/js/supabaseConfig.js"></script>
  <script src="Assets/js/Logout.js"></script>
<script>
// logout




   supabase.auth.getSession().then(({ data: { session } }) => {
        if (!session) {
            window.location.href = "Login_Admin.html";
        }
        // ROLE-BASED BACK BUTTON CONTROL
    const role = session.user.user_metadata?.role;

    if (role === "staff") {
        // staff
        const backBtn = document.getElementById("backBtn");
                if (backBtn) backBtn.style.display = "inline-block";

    } 
     else {
      


    }
   
    });
document.getElementById("logoutBtn")?.addEventListener("click", logoutUser);

function goBack(){ window.location.href = 'Insert_Admin.html'; }

   // ---- Utility functions ----
function pad(n){ return n < 10 ? '0' + n : n; }

// returns dd/mm/yyyy
function formatDateDDMMYYYY(date){
  const d = date.getDate();
  const m = date.getMonth() + 1;
  const y = date.getFullYear();
  return pad(d) + '/' + pad(m) + '/' + y;
}

// returns hh:mm AM/PM  (12-hour)
function formatTime12(date){
  let h = date.getHours();
  const m = pad(date.getMinutes());
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12;
  if (h === 0) h = 12;
  return pad(h) + ':' + m + ' ' + ampm;
}


// ---- Elements ----
const punchInBtn = document.getElementById('punchInBtn');
const punchOutBtn = document.getElementById('punchOutBtn');
const dateBox = document.getElementById('dateBox');
const timeBox = document.getElementById('timeBox');
const timeLabel = document.getElementById('timeLabel');
const statusNote = document.getElementById('statusNote');
const markBtn = document.getElementById('markBtn');
const employeeInput = document.getElementById('employeeName');

// Pre-fill date on page load
function prefillDate(){
  const now = new Date();
  dateBox.textContent = formatDateDDMMYYYY(now);
}
prefillDate();


// ----------------- PUNCH IN -----------------
punchInBtn.addEventListener('click', () => {
  const now = new Date();
  dateBox.textContent = formatDateDDMMYYYY(now);
  timeBox.textContent = formatTime12(now);
  timeLabel.innerHTML = '<b>Punch In Time</b>';


  // NO success message here (user asked only on MARK)
  // Provide a subtle visual confirmation instead (optional)
  // e.g. temporarily set a faint note (non-success)
  statusNote.style.color = "#666";
  statusNote.textContent = "Punch In captured — click MARK to save.";
  setTimeout(() => { if(statusNote.style.color === "rgb(102, 102, 102)" || statusNote.style.color === "#666") statusNote.textContent = ""; }, 2000);

  punchInBtn.disabled = true;
  punchInBtn.style.opacity = 0.6;

  punchOutBtn.disabled = false;
  punchOutBtn.style.opacity = 1;

  window.attendance = {
    date: dateBox.textContent,
    punchIn: timeBox.textContent,
    action: 'in'
  };
});


// ----------------- PUNCH OUT -----------------
punchOutBtn.addEventListener('click', () => {
  const now = new Date();
  dateBox.textContent = formatDateDDMMYYYY(now);
  timeBox.textContent = formatTime12(now);
timeLabel.innerHTML = '<b>Punch Out Time</b>';

  // NO success message here (user asked only on MARK)
  statusNote.style.color = "#666";
  statusNote.textContent = "Punch Out captured — click MARK to save.";
  setTimeout(() => { if(statusNote.style.color === "rgb(102, 102, 102)" || statusNote.style.color === "#666") statusNote.textContent = ""; }, 2000);

  punchOutBtn.disabled = true;
  punchOutBtn.style.opacity = 0.6;

  punchInBtn.disabled = false;
  punchInBtn.style.opacity = 1;

  window.attendance = {
    date: dateBox.textContent,
    punchOut: timeBox.textContent,
    action: 'out'
  };
});

const OFFICE_LAT = 9.48806788570355;
const OFFICE_LNG = 76.33736953783057;
const ALLOWED_RADIUS_METERS = 150; // 150 meters allowed

// Add this at top-level once (near other globals)
let _markInProgress = false;

// Then replace your mark handler with this:
markBtn.addEventListener('click', () => {
  // Prevent re-entrancy / double clicks
  if (_markInProgress) {
    return;
  }
  _markInProgress = true;
  markBtn.disabled = true;
  markBtn.style.opacity = 0.4;

  // 0️⃣ Validate punch precondition immediately
  if (!window.attendance || !window.attendance.action) {
    showError("Please click Punch In or Punch Out first.");
    _markInProgress = false;
    markBtn.disabled = false;
    markBtn.style.opacity = 1;
    return;
  }

  // Inform user

  navigator.geolocation.getCurrentPosition(async (pos) => {
    try {
      const userLat = pos.coords.latitude;
      const userLng = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      const distance = getDistanceInMeters(userLat, userLng, OFFICE_LAT, OFFICE_LNG);
      const distanceFormatted = Number(distance).toFixed(2);

      // show distance as info (not an error)
      //showError(`Distance from office: ${distanceFormatted} meters (accuracy ${Math.round(accuracy)} m)`);

      window.attendance.geo = {
        lat: userLat,
        lng: userLng,
        accuracy: accuracy,
        distance: Number(distanceFormatted)
      };

      // 3️⃣ Check allowed radius — ONLY THEN call proceedWithMark
      if (distance > ALLOWED_RADIUS_METERS) {
        showError(`You are ${distanceFormatted} meters away. Attendance cannot be marked.`);
        // cleanup UI / allow retry
        _markInProgress = false;
        markBtn.disabled = false;
        markBtn.style.opacity = 1;
        return;
      }

      // Inside radius -> proceed (proceedWithMark is async)
      // inside success branch when inside radius
      try {
        showSavingModal();
        await proceedWithMark(); 
      } finally {
        hideSavingModal();
      }


    } catch (err) {
      showError("Unexpected error. Try again.");
              markBtn.disabled = false;

    } finally {
      _markInProgress = false;
      if (!markBtn.disabled) {
        markBtn.style.opacity = 1;
      }
    }
  }, (err) => {
    // geolocation error
    showError("Location permission denied. Cannot mark attendance.");
    
    _markInProgress = false;
    markBtn.disabled = false;
    markBtn.style.opacity = 1;
  }, {
    enableHighAccuracy: true,
    timeout: 20000,
    maximumAge: 0
  });
});



async function loadEmployeeName() {
  try {
    const response = await fetch(
      "https://script.google.com/macros/s/AKfycbx7Y8oNGc26uGGvkQplREM2eIv_HNaUUNeP6I73jP63J2pZagzgfdqRZKkICrqUrQ6z/exec"
    );

    const json = await response.json();

    document.getElementById("employeeName").value = json.name || "";
  } catch (err) {
              showError('Failed!', 'Error fetching employee name:', { autoCloseMs: 5000 });
                            markBtn.disabled = false;


  }
}

async function proceedWithMark() {
  const emp = employeeInput.value.trim();
  if (!emp) {
    statusNote.style.color = "red";
    statusNote.textContent = "Please enter Employee Name.";
    return;
  }

  if (!window.attendance || !window.attendance.action) {
    statusNote.style.color = "red";
    statusNote.textContent = "Please click Punch In or Punch Out first.";
    return;
  }

  // Build payload for server
  const payload = {
    employee: emp,
    action: window.attendance.action || "",
    date: window.attendance.date || "",               // dd/mm/yyyy
    punchIn: window.attendance.punchIn || null,
    punchOut: window.attendance.punchOut || null,
    geo: window.attendance.geo || null,
    clientTimestampISO: new Date().toISOString()
  };

  // show saving indicator
  statusNote.style.color = "#333";
  statusNote.textContent = "Saving attendance...";

  try {
    // Assume saveAttendanceToSheet is async and throws on error or returns a JSON result
    const result = await saveAttendanceToSheet(payload);

    // If your save function returns { success: true, ... } handle that; otherwise assume no error = success
    if (result && result.success === false) {
      // server indicated failure
      statusNote.style.color = "red";
      statusNote.textContent = result.error || "Failed to save attendance.";
      return;
    }

    // Success — show appropriate message
    if (window.attendance.action === 'in') {
      showSuccess("Punch In Marked Successfully!");
          markBtn.disabled = false;

    } else {
      // If server returned present/absent, show it
      if (result) {
         showSuccess("Punch Out Marked Successfully!");
             markBtn.disabled = false;

      } 
    }

    // Reset UI (same as before)
    punchInBtn.disabled = false;
    punchOutBtn.disabled = false;
    punchInBtn.style.opacity = 1;
    punchOutBtn.style.opacity = 1;

    window.attendance = {};
    prefillDate();
    timeBox.textContent = "-- : -- --";
    timeLabel.textContent = "Punch Time";

    return true;

  } catch (err) {
    // Save failed (network/server). Show error and keep current UI/state so user can retry.
    const msg = (err && err.message) ? err.message : "Could not save attendance. Try again.";
    statusNote.style.color = "red";
    statusNote.textContent = msg;
              showError(err.message);
                            markBtn.disabled = false;


    return false;
  }
}





function getDistanceInMeters(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // meters
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  const d = R * c;
  return d;
}


async function saveAttendanceToSheet(payload) {
  const resp = await fetch("https://script.google.com/macros/s/AKfycbwTJwRXO8rSjAZ_5edJ6kRBRSemawMyhPEdYGeuwqxgupbGMfTifGVFt4Cw6mlgYNNn8w/exec", {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });

  const text = await resp.text();

  let json;
  try {
    json = JSON.parse(text);
  } catch (e) {
    throw new Error("Invalid server response");
  }

  if (!json.success) {
    throw new Error(json.error);   // ONLY message returned
  }

  return json;
}


document.addEventListener("DOMContentLoaded", loadEmployeeName);

// Show / hide helpers
function showSavingModal() {
  const m = document.getElementById('savingModal');
  if (!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
  // trap focus if needed (simple)
  document.activeElement && document.activeElement.blur();
  // prevent scrolling
  document.documentElement.style.overflow = 'hidden';
}

function hideSavingModal() {
  const m = document.getElementById('savingModal');
  if (!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
  document.documentElement.style.overflow = '';
}


    </script>
</body>
</html>
