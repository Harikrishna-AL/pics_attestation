<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="Assets/css/Admin_common.css">
<script src="Assets/js/message.js" defer></script>
<title>Mark Attendance</title>
<style>
  :root{
    --green:#1fb76a;
    --red:#e04b4b;
    --blue:#3388ff;
    --muted:#666;
    --card-bg:#fff;
  }
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:#ffffff; /* white background as requested */
    color:#222;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:24px;
  }

  .card{
    width:100%;
    max-width:560px;
    background:var(--card-bg);
    border-radius:12px;
    box-shadow:0 6px 24px rgba(20,30,60,0.08);
    padding:32px;
    text-align:center;
  }

  h1{
    margin:0 0 20px 0;
    font-size:28px;
    letter-spacing:0.4px;
  }

  .btn-row{
    display:flex;
    gap:18px;
    justify-content:center;
    margin-bottom:18px;
  }

  .btn{
    padding:14px 28px;
    border-radius:28px;
    border:0;
    color:#fff;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
    transition:transform .08s ease, box-shadow .08s ease;
  }
  .btn:active{ transform:translateY(1px); }

  .btn.in{ background: linear-gradient(180deg, #2ecc71, var(--green)); box-shadow:0 10px 30px rgba(46,204,113,0.12); }
  .btn.out{ background: linear-gradient(180deg, #ff6b6b, var(--red)); box-shadow:0 10px 30px rgba(224,75,75,0.12); }

  .field{
    margin:14px 0;
    text-align:left;
  }
  label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin-bottom:6px;
  }
  input[type="text"], .display-box{
    width:100%;
    padding:12px 14px;
    border-radius:8px;
    border:1px solid #e6e6e6;
    font-size:14px;
    background:#fafafa;
    color:#111;
    box-sizing:border-box;
  }
  .row{
    display:flex;
    gap:12px;
    margin-top:10px;
  }
  .row .col{
    flex:1;
  }
  .small-box{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #e6e6e6;
    background:#fafafa;
    font-size:14px;
    justify-content:space-between;
  }
  .small-label{ font-size:12px; color:var(--muted); margin-bottom:6px; display:block; }
  .mark-btn{
    margin-top:20px;
    width:60%;
    max-width:320px;
    background:var(--blue);
    color:#fff;
    border-radius:28px;
    padding:12px 18px;
    border:0;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(51,136,255,0.16);
  }

  .note{ color:var(--muted); font-size:13px; margin-top:8px; }

  /* small responsive */
  @media (max-width:420px){
    .btn-row{ flex-direction:column; }
    .btn{ width:100%; }
    .mark-btn{ width:100%; }
  }
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Mark Attendance</h1>

    <div class="btn-row" role="group" aria-label="Punch controls">
      <button id="punchInBtn" class="btn in" type="button">PUNCH IN</button>
      <button id="punchOutBtn" class="btn out" type="button">PUNCH OUT</button>
    </div>

    <div class="field">
      <label for="employeeName">Employee Name:</label>
<input id="employeeName" type="text" disabled />
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <label class="small-label">Date</label>
        <div id="dateBox" class="small-box">-- / -- / ----</div>
      </div>
      <div class="col">
        <label class="small-label" id="timeLabel">Punch In Time</label>
        <div id="timeBox" class="small-box">-- : -- --</div>
      </div>
    </div>

    <button id="markBtn" class="mark-btn" type="button">MARK</button>
    <div class="note" id="statusNote"></div>
  </div>

<script>
   // ---- Utility functions ----
function pad(n){ return n < 10 ? '0' + n : n; }

// returns dd/mm/yyyy
function formatDateDDMMYYYY(date){
  const d = date.getDate();
  const m = date.getMonth() + 1;
  const y = date.getFullYear();
  return pad(d) + '/' + pad(m) + '/' + y;
}

// returns hh:mm AM/PM  (12-hour)
function formatTime12(date){
  let h = date.getHours();
  const m = pad(date.getMinutes());
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12;
  if (h === 0) h = 12;
  return pad(h) + ':' + m + ' ' + ampm;
}


// ---- Elements ----
const punchInBtn = document.getElementById('punchInBtn');
const punchOutBtn = document.getElementById('punchOutBtn');
const dateBox = document.getElementById('dateBox');
const timeBox = document.getElementById('timeBox');
const timeLabel = document.getElementById('timeLabel');
const statusNote = document.getElementById('statusNote');
const markBtn = document.getElementById('markBtn');
const employeeInput = document.getElementById('employeeName');

// Pre-fill date on page load
function prefillDate(){
  const now = new Date();
  dateBox.textContent = formatDateDDMMYYYY(now);
}
prefillDate();


// ----------------- PUNCH IN -----------------
punchInBtn.addEventListener('click', () => {
  const now = new Date();
  dateBox.textContent = formatDateDDMMYYYY(now);
  timeBox.textContent = formatTime12(now);
  timeLabel.textContent = 'Punch In Time';

  // NO success message here (user asked only on MARK)
  // Provide a subtle visual confirmation instead (optional)
  // e.g. temporarily set a faint note (non-success)
  statusNote.style.color = "#666";
  statusNote.textContent = "Punch In captured â€” click MARK to save.";
  setTimeout(() => { if(statusNote.style.color === "rgb(102, 102, 102)" || statusNote.style.color === "#666") statusNote.textContent = ""; }, 2000);

  punchInBtn.disabled = true;
  punchInBtn.style.opacity = 0.6;

  punchOutBtn.disabled = false;
  punchOutBtn.style.opacity = 1;

  window.attendance = {
    date: dateBox.textContent,
    punchIn: timeBox.textContent,
    action: 'in'
  };
});


// ----------------- PUNCH OUT -----------------
punchOutBtn.addEventListener('click', () => {
  const now = new Date();
  dateBox.textContent = formatDateDDMMYYYY(now);
  timeBox.textContent = formatTime12(now);
  timeLabel.textContent = 'Punch Out Time';

  // NO success message here (user asked only on MARK)
  statusNote.style.color = "#666";
  statusNote.textContent = "Punch Out captured â€” click MARK to save.";
  setTimeout(() => { if(statusNote.style.color === "rgb(102, 102, 102)" || statusNote.style.color === "#666") statusNote.textContent = ""; }, 2000);

  punchOutBtn.disabled = true;
  punchOutBtn.style.opacity = 0.6;

  punchInBtn.disabled = false;
  punchInBtn.style.opacity = 1;

  window.attendance = {
    date: dateBox.textContent,
    punchOut: timeBox.textContent,
    action: 'out'
  };
});

markBtn.addEventListener('click', () => {

  // 1ï¸âƒ£ Ask for user location
  navigator.geolocation.getCurrentPosition(async (pos) => {

      const userLat = pos.coords.latitude;
      const userLng = pos.coords.longitude;

      // 2ï¸âƒ£ Compare with office location
      const distance = getDistanceInMeters(userLat, userLng, OFFICE_LAT, OFFICE_LNG);

      showError("Distance from office:", distance);

      // 3ï¸âƒ£ Check allowed radius
      if (distance > ALLOWED_RADIUS_METERS) {
        showError("You are not near the office. Attendance cannot be marked.");
        return; 
      }

      // ðŸŸ¢ If inside office radius â†’ continue with existing MARK logic
      proceedWithMark();

  }, (err) => {
      showError(" Location permission denied. Cannot mark attendance.");
  });
});


async function loadEmployeeName() {
  try {
    const response = await fetch(
      "https://script.google.com/macros/s/AKfycbx7Y8oNGc26uGGvkQplREM2eIv_HNaUUNeP6I73jP63J2pZagzgfdqRZKkICrqUrQ6z/exec"
    );

    const json = await response.json();

    document.getElementById("employeeName").value = json.name || "";
  } catch (err) {
              showError('Failed!', 'Error fetching employee name:', { autoCloseMs: 5000 });

  }
}

function proceedWithMark() {
  const emp = employeeInput.value.trim();
  if(!emp){
    statusNote.style.color = "red";
    statusNote.textContent = "Please enter Employee Name.";
    return;
  }

  if(!window.attendance || !window.attendance.action){
    statusNote.style.color = "red";
    statusNote.textContent = "Please click Punch In or Punch Out first.";
    return;
  }

  console.log("MARKED:", window.attendance);

  // Show success message depending on action
  if(window.attendance.action === 'in'){
    showSuccess("Punch In Marked Successfully!");
  } else {
    showSuccess("Punch Out Marked Successfully!");
  }

  // Reset UI
  punchInBtn.disabled = false;
  punchOutBtn.disabled = false;
  punchInBtn.style.opacity = 1;
  punchOutBtn.style.opacity = 1;

  window.attendance = {};
  prefillDate();
  timeBox.textContent = "-- : -- --";
  timeLabel.textContent = "Punch Time";
}

const OFFICE_LAT = 9.48806788570355;
const OFFICE_LNG = 76.33736953783057;
const ALLOWED_RADIUS_METERS = 150; // 150 meters allowed


function getDistanceInMeters(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // meters
  const Ï†1 = lat1 * Math.PI/180;
  const Ï†2 = lat2 * Math.PI/180;
  const Î”Ï† = (lat2-lat1) * Math.PI/180;
  const Î”Î» = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
            Math.cos(Ï†1) * Math.cos(Ï†2) *
            Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  const d = R * c;
  return d;
}


document.addEventListener("DOMContentLoaded", loadEmployeeName);


    </script>
</body>
</html>
